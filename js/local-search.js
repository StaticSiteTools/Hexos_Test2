window.addEventListener("DOMContentLoaded",()=>{let datas,isfetched=!1,isXml=!0,searchPath=CONFIG.path;0===searchPath.length?searchPath="search.xml":searchPath.endsWith("json")&&(isXml=!1);const input=document.querySelector(".search-input"),resultContent=document.getElementById("search-result"),getIndexByWord=(word,text,caseSensitive)=>{if(CONFIG.localsearch.unescape){let div=document.createElement("div");div.innerText=word,word=div.innerHTML}let wordLen=word.length;if(0===wordLen)return[];let startPosition=0,position=[],index=[];for(caseSensitive||(text=text.toLowerCase(),word=word.toLowerCase());(position=text.indexOf(word,startPosition))>-1;)index.push({position:position,word:word}),startPosition=position+wordLen;return index},mergeIntoSlice=(start,end,index,searchText)=>{let item=index[index.length-1],{position:position,word:word}=item,hits=[],searchTextCountInSlice=0;for(;position+word.length<=end&&0!==index.length;){word===searchText&&searchTextCountInSlice++,hits.push({position:position,length:word.length});let wordEnd=position+word.length;for(index.pop();0!==index.length&&(position=(item=index[index.length-1]).position,word=item.word,wordEnd>position);)index.pop()}return{hits:hits,start:start,end:end,searchTextCount:searchTextCountInSlice}},highlightKeyword=(text,slice)=>{let result="",prevEnd=slice.start;return slice.hits.forEach(hit=>{result+=text.substring(prevEnd,hit.position);let end=hit.position+hit.length;result+=`<b class="search-keyword">${text.substring(hit.position,end)}</b>`,prevEnd=end}),result+=text.substring(prevEnd,slice.end)},inputEventFunction=()=>{if(!isfetched)return;let searchText=input.value.trim().toLowerCase(),keywords=searchText.split(/[-\s]+/);keywords.length>1&&keywords.push(searchText);let resultItems=[];searchText.length>0&&datas.forEach(({title:title,content:content,url:url})=>{let titleInLowerCase=title.toLowerCase(),contentInLowerCase=content.toLowerCase(),indexOfTitle=[],indexOfContent=[],searchTextCount=0;if(keywords.forEach(keyword=>{indexOfTitle=indexOfTitle.concat(getIndexByWord(keyword,titleInLowerCase,!1)),indexOfContent=indexOfContent.concat(getIndexByWord(keyword,contentInLowerCase,!1))}),indexOfTitle.length>0||indexOfContent.length>0){let hitCount=indexOfTitle.length+indexOfContent.length;[indexOfTitle,indexOfContent].forEach(index=>{index.sort((itemLeft,itemRight)=>itemRight.position!==itemLeft.position?itemRight.position-itemLeft.position:itemLeft.word.length-itemRight.word.length)});let slicesOfTitle=[];if(0!==indexOfTitle.length){let tmp=mergeIntoSlice(0,title.length,indexOfTitle,searchText);searchTextCount+=tmp.searchTextCountInSlice,slicesOfTitle.push(tmp)}let slicesOfContent=[];for(;0!==indexOfContent.length;){let item=indexOfContent[indexOfContent.length-1],{position:position,word:word}=item,start=position-20,end=position+80;start<0&&(start=0),end<position+word.length&&(end=position+word.length),end>content.length&&(end=content.length);let tmp=mergeIntoSlice(start,end,indexOfContent,searchText);searchTextCount+=tmp.searchTextCountInSlice,slicesOfContent.push(tmp)}slicesOfContent.sort((sliceLeft,sliceRight)=>sliceLeft.searchTextCount!==sliceRight.searchTextCount?sliceRight.searchTextCount-sliceLeft.searchTextCount:sliceLeft.hits.length!==sliceRight.hits.length?sliceRight.hits.length-sliceLeft.hits.length:sliceLeft.start-sliceRight.start);let upperBound=parseInt(CONFIG.localsearch.top_n_per_article,10);upperBound>=0&&(slicesOfContent=slicesOfContent.slice(0,upperBound));let resultItem="";0!==slicesOfTitle.length?resultItem+=`<li><a href="${url}" class="search-result-title">${highlightKeyword(title,slicesOfTitle[0])}</a>`:resultItem+=`<li><a href="${url}" class="search-result-title">${title}</a>`,slicesOfContent.forEach(slice=>{resultItem+=`<a href="${url}"><p class="search-result">${highlightKeyword(content,slice)}...</p></a>`}),resultItem+="</li>",resultItems.push({item:resultItem,id:resultItems.length,hitCount:hitCount,searchTextCount:searchTextCount})}}),1===keywords.length&&""===keywords[0]?resultContent.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>':0===resultItems.length?resultContent.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>':(resultItems.sort((resultLeft,resultRight)=>resultLeft.searchTextCount!==resultRight.searchTextCount?resultRight.searchTextCount-resultLeft.searchTextCount:resultLeft.hitCount!==resultRight.hitCount?resultRight.hitCount-resultLeft.hitCount:resultRight.id-resultLeft.id),resultContent.innerHTML=`<ul class="search-result-list">${resultItems.map(result=>result.item).join("")}</ul>`,window.pjax&&window.pjax.refresh(resultContent))},fetchData=()=>{fetch(CONFIG.root+searchPath).then(response=>response.text()).then(res=>{isfetched=!0,datas=(datas=isXml?[...(new DOMParser).parseFromString(res,"text/xml").querySelectorAll("entry")].map(element=>({title:element.querySelector("title").textContent,content:element.querySelector("content").textContent,url:element.querySelector("url").textContent})):JSON.parse(res)).filter(data=>data.title).map(data=>(data.title=data.title.trim(),data.content=data.content?data.content.trim().replace(/<[^>]+>/g,""):"",data.url=decodeURIComponent(data.url).replace(/\/{2,}/g,"/"),data)),document.getElementById("no-result").innerHTML='<i class="fa fa-search fa-5x"></i>',inputEventFunction()})};CONFIG.localsearch.preload&&fetchData(),"auto"===CONFIG.localsearch.trigger?input.addEventListener("input",inputEventFunction):(document.querySelector(".search-icon").addEventListener("click",inputEventFunction),input.addEventListener("keypress",event=>{"Enter"===event.key&&inputEventFunction()})),document.querySelectorAll(".popup-trigger").forEach(element=>{element.addEventListener("click",()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").classList.add("search-active"),input.focus(),isfetched||fetchData()})});const onPopupClose=()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").classList.remove("search-active")};document.querySelector(".search-pop-overlay").addEventListener("click",event=>{event.target===document.querySelector(".search-pop-overlay")&&onPopupClose()}),document.querySelector(".popup-btn-close").addEventListener("click",onPopupClose),window.addEventListener("pjax:success",onPopupClose),window.addEventListener("keyup",event=>{"Escape"===event.key&&onPopupClose()})});